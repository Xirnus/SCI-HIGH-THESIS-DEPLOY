<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="public/assets/img/logo/SCI-HIGH_LOGO.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SCI-HIGH: Global Leaderboards</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Gaming Feel -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Modern Notification System -->
    <script src="js/notifications.js"></script>
    <script>
      // Suppress SES security warnings (they're informational only)
      const originalConsoleWarn = console.warn;
      console.warn = function(...args) {
        const message = args.join(' ');
        // Only suppress SES-related warnings
        if (message.includes('SES') || message.includes('lockdown-install.js') || message.includes('Removing intrinsics')) {
          return; // Suppress SES warnings
        }
        originalConsoleWarn.apply(console, args);
      };

      // Fallback functions in case notifications.js hasn't loaded yet
      window.ensureNotifications = function() {
        if (typeof window.modernConfirm === 'undefined') {
          console.warn('Notification system not loaded, using fallback');
          window.modernConfirm = function(message, options = {}) {
            return Promise.resolve(confirm(message));
          };
          window.modernAlert = function(message, options = {}) {
            alert(message);
            return Promise.resolve(true);
          };
          window.showSuccess = function(message, options = {}) {
            alert('‚úÖ ' + message);
            return Promise.resolve(true);
          };
          window.showError = function(message, options = {}) {
            alert('‚ùå ' + message);
            return Promise.resolve(true);
          };
          window.showWarning = function(message, options = {}) {
            alert('‚ö†Ô∏è ' + message);
            return Promise.resolve(true);
          };
          window.showInfo = function(message, options = {}) {
            alert('‚ÑπÔ∏è ' + message);
            return Promise.resolve(true);
          };
        }
      };
      
      // Ensure notifications are available immediately
      window.ensureNotifications();
    </script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#F4CE14', // yellow
              accent: '#379777', // green
              dark: '#1a1a2e',   // darker navy
              light: '#16213e',  // dark blue
              purple: '#9c27b0', // gaming purple
              cyan: '#00bcd4',   // gaming cyan
              textColor: '#ffffff',
              cardBg: 'rgba(22, 33, 62, 0.8)',
            },
            fontFamily: {
              gaming: ['Orbitron', 'monospace'],
              body: ['Exo 2', 'sans-serif'],
            },
            animation: {
              'pulse-glow': 'pulse-glow 2s ease-in-out infinite alternate',
              'float': 'float 6s ease-in-out infinite',
              'slide-in': 'slide-in 0.8s ease-out',
              'bounce-in': 'bounce-in 1s ease-out',
              'rank-glow': 'rank-glow 3s ease-in-out infinite',
            }
          }
        }
      }
    </script>
    <style>
      @keyframes pulse-glow {
        from { box-shadow: 0 0 20px #F4CE14; }
        to { box-shadow: 0 0 30px #F4CE14, 0 0 40px #F4CE14; }
      }
      @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-20px); }
      }
      @keyframes slide-in {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes bounce-in {
        0% { transform: scale(0); opacity: 0; }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
      }
      @keyframes rank-glow {
        0%, 100% { box-shadow: 0 0 10px rgba(244, 206, 20, 0.3); }
        50% { box-shadow: 0 0 20px rgba(244, 206, 20, 0.8); }
      }
      
      .game-bg {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f172a 100%);
        position: relative;
        overflow-x: hidden;
      }
      
      .game-bg::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
          radial-gradient(circle at 20% 80%, rgba(244, 206, 20, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(55, 151, 119, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 40% 40%, rgba(156, 39, 176, 0.1) 0%, transparent 50%);
        animation: float 8s ease-in-out infinite;
        pointer-events: none;
        z-index: -1;
      }
      
      .neon-border {
        border: 2px solid #F4CE14;
        background: rgba(22, 33, 62, 0.8);
        box-shadow: 0 0 10px rgba(244, 206, 20, 0.3);
      }
      
      /* Custom modal animations */
      .modal-enter {
        animation: modalFadeIn 0.3s ease-out;
      }
      
      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      
      /* Gaming rank styles */
      .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
      .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
      .rank-3 { background: linear-gradient(135deg, #CD7F32, #B8860B); }
      
      /* Hover effects for clickable names */
      .player-name-link {
        transition: all 0.2s ease;
      }
      
      .player-name-link:hover {
        transform: translateY(-1px);
        text-shadow: 0 2px 4px rgba(244, 206, 20, 0.5);
      }
    </style>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <!-- Lightweight custom charts - no external dependencies needed -->
  </head>
  <body class="font-body game-bg text-textColor m-0 p-0 leading-relaxed min-h-screen flex flex-col">
    <!-- Particle Background Effect -->
    <div id="particles" class="fixed inset-0 pointer-events-none z-0"></div>
    
    <!-- Gaming HUD Navigation -->
    <nav class="relative z-50 bg-gradient-to-r from-dark/90 to-light/90 backdrop-blur-md border-b-2 border-primary/30 py-4 sticky top-0">
      <div class="max-w-6xl mx-auto px-4 sm:px-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2 sm:space-x-4">
            <img src="public/assets/img/buko_productions-logo.png" alt="Buko Productions Logo" class="w-10 h-10 sm:w-12 sm:h-12 animate-bounce-in" />
            <span class="font-gaming text-lg sm:text-xl font-bold text-primary">SCI-HIGH</span>
          </div>
          
          <!-- Mobile menu button -->
          <div class="md:hidden">
            <button id="mobile-menu-btn" type="button" class="text-textColor hover:text-primary focus:outline-none focus:text-primary transition-colors duration-300" aria-controls="mobile-menu" aria-expanded="false">
              <span class="sr-only">Open main menu</span>
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
          </div>
          
          <!-- Desktop navigation -->
          <div class="hidden md:flex space-x-8">
            <a href="index.html" class="gaming-nav-link text-textColor hover:text-primary transition-all duration-300 font-gaming text-sm uppercase tracking-wider relative">
              <span class="relative z-10">Home</span>
              <div class="absolute inset-0 bg-primary/20 transform skew-x-12 scale-x-0 transition-transform duration-300 hover:scale-x-100"></div>
            </a>
            <a href="index.html#about" class="gaming-nav-link text-textColor hover:text-primary transition-all duration-300 font-gaming text-sm uppercase tracking-wider relative">
              <span class="relative z-10">About</span>
              <div class="absolute inset-0 bg-primary/20 transform skew-x-12 scale-x-0 transition-transform duration-300 hover:scale-x-100"></div>
            </a>
            <a href="index.html#contact" class="gaming-nav-link text-textColor hover:text-primary transition-all duration-300 font-gaming text-sm uppercase tracking-wider relative">
              <span class="relative z-10">Contact</span>
              <div class="absolute inset-0 bg-primary/20 transform skew-x-12 scale-x-0 transition-transform duration-300 hover:scale-x-100"></div>
            </a>
          </div>
        </div>
        
        <!-- Mobile navigation menu -->
        <div class="md:hidden" id="mobile-menu" style="display: none;">
          <div class="px-3 pt-3 pb-4 space-y-2 bg-gradient-to-br from-dark/98 to-light/98 backdrop-blur-xl rounded-xl mt-3 border-2 border-primary/40 shadow-xl shadow-primary/20">
            <a href="index.html" class="block px-4 py-3 text-textColor hover:text-primary hover:bg-primary/10 font-gaming text-sm uppercase tracking-wider transition-all duration-300 rounded-lg border border-transparent hover:border-primary/30">
              <span class="flex items-center">
                <span class="mr-2">üè†</span> Home
              </span>
            </a>
            <a href="index.html#about" class="block px-4 py-3 text-textColor hover:text-primary hover:bg-primary/10 font-gaming text-sm uppercase tracking-wider transition-all duration-300 rounded-lg border border-transparent hover:border-primary/30">
              <span class="flex items-center">
                <span class="mr-2">‚ÑπÔ∏è</span> About
              </span>
            </a>
            <a href="index.html#contact" class="block px-4 py-3 text-textColor hover:text-primary hover:bg-primary/10 font-gaming text-sm uppercase tracking-wider transition-all duration-300 rounded-lg border border-transparent hover:border-primary/30">
              <span class="flex items-center">
                <span class="mr-2">üìû</span> Contact
              </span>
            </a>
          </div>
        </div>
      </div>
    </nav>
    
    <!-- Main content wrapper with flex-grow to push footer down -->
    <div class="flex-grow relative z-10">
      <!-- Hero Section -->
      <section class="py-12 sm:py-16 px-4 sm:px-6">
        <div class="max-w-6xl mx-auto text-center">
          <div class="mb-8 sm:mb-12 animate-bounce-in">
            <h1 class="font-gaming text-3xl sm:text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-primary via-accent to-cyan mb-4 sm:mb-6">
              üèÜ Global Leaderboards
            </h1>
            <p class="text-base sm:text-lg md:text-xl text-gray-300 max-w-3xl mx-auto mb-6 sm:mb-8 px-4">
              Compete with programmers worldwide and climb the ranks in the ultimate coding challenge!
            </p>
          </div>
          
          <!-- Gaming Filter Buttons -->
          <div class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8 sm:mb-12 animate-slide-in px-2 sm:px-4">
            <button class="filter-btn px-3 xs:px-4 sm:px-8 py-2 sm:py-3 font-gaming text-xs sm:text-sm uppercase tracking-wider rounded-xl font-bold text-dark bg-gradient-to-r from-primary to-yellow-300 transform transition-all duration-300 hover:scale-105 hover:shadow-lg hover:shadow-primary/50 border-2 border-primary touch-manipulation" data-filter="overall">
              <span class="relative z-10">üåü Overall</span>
            </button>
            <button class="filter-btn px-3 xs:px-4 sm:px-8 py-2 sm:py-3 font-gaming text-xs sm:text-sm uppercase tracking-wider rounded-xl font-bold text-textColor bg-gradient-to-r from-accent to-cyan transform transition-all duration-300 hover:scale-105 hover:shadow-lg hover:shadow-accent/50 border-2 border-accent/50 touch-manipulation" data-filter="college">
              <span class="relative z-10">üéì College</span>
            </button>
            <button class="filter-btn px-3 xs:px-4 sm:px-8 py-2 sm:py-3 font-gaming text-xs sm:text-sm uppercase tracking-wider rounded-xl font-bold text-textColor bg-gradient-to-r from-purple to-pink-500 transform transition-all duration-300 hover:scale-105 hover:shadow-lg hover:shadow-purple/50 border-2 border-purple/50 touch-manipulation" data-filter="seniorhigh">
              <span class="relative z-10">üìö Senior High</span>
            </button>
            <button class="filter-btn px-3 xs:px-4 sm:px-8 py-2 sm:py-3 font-gaming text-xs sm:text-sm uppercase tracking-wider rounded-xl font-bold text-textColor bg-gradient-to-r from-cyan to-blue-500 transform transition-all duration-300 hover:scale-105 hover:shadow-lg hover:shadow-cyan/50 border-2 border-cyan/50 touch-manipulation" data-filter="juniorhigh">
              <span class="relative z-10">üéí Junior High</span>
            </button>
          </div>
          
          <!-- Students Only Notice -->
          <div class="bg-gradient-to-r from-blue-900/30 to-purple-900/30 border border-blue-400/50 rounded-lg p-4 mb-8 text-center">
            <p class="text-blue-300 font-gaming">
              <span class="text-yellow-300">üéì</span> Student Leaderboard <span class="text-yellow-300">üéì</span>
            </p>
            <p class="text-gray-300 text-sm mt-1">Only registered students appear on the leaderboards. Scores are linked to official student records.</p>
          </div>
        </div>
      </section>

      <!-- Leaderboard Section -->
      <section class="px-6 pb-16">
        <div class="max-w-6xl mx-auto">
          <div class="neon-border rounded-xl backdrop-blur-sm p-8">
            <div class="flex items-center justify-between mb-8">
              <h2 class="font-gaming text-2xl font-bold text-primary flex items-center gap-3">
                <span class="text-3xl">‚öîÔ∏è</span>
                Battle Rankings
              </h2>
              <div class="flex items-center gap-4 text-sm text-gray-400">
                <span class="flex items-center gap-2">
                  <div class="w-3 h-3 bg-primary rounded-full animate-pulse"></div>
                  Live Updates
                </span>
                <span id="player-count">Loading...</span>
              </div>
            </div>

            <!-- Featured Players Section (Top 3) -->
            <div id="featured-players" class="mt-8 mb-8">
              <div class="neon-border rounded-xl shadow-xl overflow-hidden backdrop-blur-sm bg-dark/50">
                <div class="bg-gradient-to-r from-dark via-light to-dark text-white p-6 border-b-2 border-primary/30">
                  <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-primary to-yellow-300 rounded-lg flex items-center justify-center neon-border">
                      <img src="public/assets/img/icons/office/achievements.png" alt="Featured" class="w-8 h-8 object-contain" />
                    </div>
                    <div>
                      <h2 class="font-gaming text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-accent">Top Champions</h2>
                      <p class="text-gray-300 font-body text-sm">The elite warriors leading the leaderboards</p>
                    </div>
                  </div>
                </div>
                
                <!-- Player Cards Grid -->
                <div id="player-cards-container" class="p-6">
                  <div id="player-cards-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Player cards will be inserted here by JavaScript -->
                  </div>
                  
                  <!-- Loading State for Player Cards -->
                  <div id="player-cards-loading" class="text-center py-8">
                    <div class="flex flex-col items-center space-y-3">
                      <div class="w-12 h-12 border-3 border-primary border-t-transparent rounded-full animate-spin"></div>
                      <p class="text-gray-400 font-gaming text-sm">Loading champions...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div id="leaderboard-list" class="mt-8 space-y-8">
              <!-- Global Leaderboard Section -->
              <div id="global-leaderboard" class="leaderboard-section">
                <div class="neon-border rounded-xl shadow-xl overflow-hidden backdrop-blur-sm bg-dark/50">
                  <!-- Leaderboard Header -->
                  <div class="bg-gradient-to-r from-dark via-light to-dark text-white p-8 border-b-2 border-primary/30">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                      <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-gradient-to-br from-primary to-yellow-300 rounded-xl flex items-center justify-center neon-border animate-float">
                          <img src="public/assets/img/icons/office/achievements.png" alt="Achievements" class="w-10 h-10 object-contain" />
                        </div>
                        <div>
                          <h2 class="font-gaming text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-accent">Global Champions</h2>
                          <p class="text-gray-300 font-body">Top warriors across all departments</p>
                        </div>
                      </div>
                      <div class="text-center">
                        <div class="text-sm text-gray-400 font-gaming">Total Players</div>
                        <div id="total-players" class="text-2xl font-gaming font-bold text-primary">0</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Leaderboard Table -->
                  <div class="overflow-x-auto">
                    <table class="w-full">
                      <thead>
                        <tr class="bg-gradient-to-r from-primary/20 to-accent/20 border-b border-primary/30">
                          <th class="px-6 py-4 text-left font-gaming text-primary border-r border-primary/30">
                            <span class="flex items-center space-x-2">
                              <span>‚ö°</span>
                              <span>Rank</span>
                            </span>
                          </th>
                          <th class="px-6 py-4 text-left font-gaming text-primary border-r border-primary/30">
                            <span class="flex items-center space-x-2">
                              <span>üéÆ</span>
                              <span>Player</span>
                            </span>
                          </th>
                          <th class="px-6 py-4 text-left font-gaming text-primary border-r border-primary/30">
                            <span class="flex items-center space-x-2">
                              <span>üè´</span>
                              <span>Department</span>
                            </span>
                          </th>
                          <th class="px-6 py-4 text-left font-gaming text-primary border-r border-primary/30">
                            <span class="flex items-center space-x-2">
                              <span>‚≠ê</span>
                              <span>Battle Score</span>
                            </span>
                          </th>
                          <th class="px-6 py-4 text-left font-gaming text-primary border-r border-primary/30">
                            <span class="flex items-center space-x-2">
                              <span>üéØ</span>
                              <span>Accuracy</span>
                            </span>
                          </th>
                          <th class="px-6 py-4 text-left font-gaming text-primary">
                            <span class="flex items-center space-x-2">
                              <span>üî•</span>
                              <span>Max Combo</span>
                            </span>
                          </th>
                        </tr>
                      </thead>
                      <tbody id="global-leaderboard-body" class="divide-y divide-primary/20">
                        <!-- Leaderboard rows will be inserted here by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  
                  <!-- Loading State -->
                  <div id="global-loading" class="text-center py-16">
                    <div class="flex flex-col items-center space-y-4">
                      <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                      <p class="text-gray-400 font-gaming">Loading battle results...</p>
                    </div>
                  </div>
                  
                  <!-- Empty State -->
                  <div id="global-empty" class="text-center py-16 hidden">
                    <div class="flex flex-col items-center space-y-4">
                      <div class="w-24 h-24 bg-gradient-to-br from-primary/20 to-accent/20 rounded-xl flex items-center justify-center">
                        <img src="public/assets/img/mainhub/PLAY_BUTTON.png" alt="Play" class="w-16 h-16 object-contain" />
                      </div>
                      <h3 class="text-xl font-gaming font-bold text-gray-300">No Champions Yet</h3>
                      <p class="text-gray-400 font-body">Be the first to join the leaderboard!</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Department Leaderboard Section -->
              <div id="department-leaderboard" class="leaderboard-section hidden">
                <div class="neon-border rounded-xl shadow-xl overflow-hidden backdrop-blur-sm bg-dark/50">
                  <!-- Department Header -->
                  <div class="bg-gradient-to-r from-dark via-light to-dark text-white p-8 border-b-2 border-accent/30">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                      <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-gradient-to-br from-accent to-cyan-400 rounded-xl flex items-center justify-center neon-border animate-float">
                          <img src="public/assets/img/mainhub/office_icon.png" alt="Office" class="w-10 h-10 object-contain" />
                        </div>
                        <div>
                          <h2 class="font-gaming text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-accent to-cyan-400">Department Leaders</h2>
                          <p id="department-subtitle" class="text-gray-300 font-body">Elite warriors of the department</p>
                        </div>
                      </div>
                      <div class="text-center">
                        <div class="text-sm text-gray-400 font-gaming">Department Players</div>
                        <div id="dept-total-players" class="text-2xl font-gaming font-bold text-accent">0</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Department Table -->
                  <div class="overflow-x-auto">
                    <table class="w-full">
                      <thead>
                        <tr class="bg-gradient-to-r from-accent/20 to-cyan-400/20 border-b border-accent/30">
                          <th class="px-6 py-4 text-left font-gaming text-accent border-r border-accent/30">
                            <span class="flex items-center space-x-2">
                              <span>‚ö°</span>
                              <span>Rank</span>
                            </span>
                          </th>
                          <th class="px-6 py-4 text-left font-gaming text-accent border-r border-accent/30">
                            <span class="flex items-center space-x-2">
                              <span>üéÆ</span>
                              <span>Player</span>
                            </span>
                          </th>
                          <th class="px-6 py-4 text-left font-gaming text-accent border-r border-accent/30">
                            <span class="flex items-center space-x-2">
                              <span>‚≠ê</span>
                              <span>Battle Score</span>
                            </span>
                          </th>
                          <th class="px-6 py-4 text-left font-gaming text-accent border-r border-accent/30">
                            <span class="flex items-center space-x-2">
                              <span>üéØ</span>
                              <span>Accuracy</span>
                            </span>
                          </th>
                          <th class="px-6 py-4 text-left font-gaming text-accent border-r border-accent/30">
                            <span class="flex items-center space-x-2">
                              <span>üî•</span>
                              <span>Max Combo</span>
                            </span>
                          </th>
                          <th class="px-6 py-4 text-left font-gaming text-accent">
                            <span class="flex items-center space-x-2">
                              <span>üìä</span>
                              <span>Global Rank</span>
                            </span>
                          </th>
                        </tr>
                      </thead>
                      <tbody id="department-leaderboard-body" class="divide-y divide-accent/20">
                        <!-- Department leaderboard rows will be inserted here by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  
                  <!-- Department Loading State -->
                  <div id="department-loading" class="text-center py-16">
                    <div class="flex flex-col items-center space-y-4">
                      <div class="w-16 h-16 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
                      <p class="text-gray-400 font-gaming">Loading department champions...</p>
                    </div>
                  </div>
                  
                  <!-- Department Empty State -->
                  <div id="department-empty" class="text-center py-16 hidden">
                    <div class="flex flex-col items-center space-y-4">
                      <div class="w-24 h-24 bg-gradient-to-br from-accent/20 to-cyan-400/20 rounded-xl flex items-center justify-center">
                        <img src="public/assets/img/mainhub/office_icon.png" alt="Office" class="w-16 h-16 object-contain" />
                      </div>
                      <h3 class="text-xl font-gaming font-bold text-gray-300">No Department Champions</h3>
                      <p class="text-gray-400 font-body">Rise up and claim your department's glory!</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Player Profile Modal -->
    <div id="player-profile-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center hidden">
      <div class="neon-border rounded-xl shadow-2xl max-w-7xl w-full mx-4 max-h-[95vh] overflow-y-auto">
        <div class="relative">
          <!-- Header Section with Avatar and Basic Info -->
          <div id="profile-header" class="relative bg-gradient-to-r from-dark via-light to-dark text-white p-8 rounded-t-xl">
            <!-- Close button -->
            <button onclick="closePlayerProfile()" class="absolute top-4 right-4 text-white hover:text-primary text-3xl font-gaming font-bold z-10 transition-colors duration-300">&times;</button>
            
            <!-- Player Info Container -->
            <div class="flex flex-col lg:flex-row items-start lg:items-end gap-6">
              <!-- Avatar Section -->
              <div class="flex-shrink-0">
                <div class="w-32 h-32 bg-gradient-to-br from-primary to-yellow-300 rounded-xl shadow-lg flex items-center justify-center neon-border">
                  <div id="player-avatar" class="w-24 h-24 bg-dark rounded-full flex items-center justify-center text-primary text-3xl font-gaming font-bold">
                    <!-- Avatar will be generated from player name -->
                  </div>
                </div>
              </div>
              
              <!-- Player Info -->
              <div class="flex-grow">
                <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
                  <!-- Name and Location -->
                  <div>
                    <h2 id="profile-player-name" class="font-gaming text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-primary to-accent">Player Name</h2>
                    <p id="profile-department" class="text-xl opacity-90 flex items-center gap-2">
                      <span class="inline-block w-6 h-4 bg-primary rounded shadow"></span>
                      Department
                    </p>
                  </div>
                  
                  <!-- Rankings -->
                  <div class="flex gap-8">
                    <div class="text-center">
                      <div class="text-sm opacity-75 font-gaming">Global Rank</div>
                      <div id="global-rank" class="text-2xl font-gaming font-bold text-primary">#0</div>
                    </div>
                    <div class="text-center">
                      <div class="text-sm opacity-75 font-gaming">Department Rank</div>
                      <div id="dept-rank" class="text-2xl font-gaming font-bold text-accent">#0</div>
                    </div>
                  </div>
                </div>
                
                <!-- Stats Bar -->
                <div class="mt-6 grid grid-cols-2 lg:grid-cols-6 gap-4 text-center">
                  <div class="bg-cardBg rounded-lg p-3 neon-border">
                    <div class="text-xs opacity-75 font-gaming">Ranked Score</div>
                    <div id="ranked-score" class="text-lg font-gaming font-bold text-primary">0</div>
                  </div>
                  <div class="bg-cardBg rounded-lg p-3 neon-border">
                    <div class="text-xs opacity-75 font-gaming">Accuracy</div>
                    <div id="accuracy" class="text-lg font-gaming font-bold text-accent">0%</div>
                  </div>
                  <div class="bg-cardBg rounded-lg p-3 neon-border">
                    <div class="text-xs opacity-75 font-gaming">Quiz Count</div>
                    <div id="quiz-count" class="text-lg font-gaming font-bold text-cyan">0</div>
                  </div>
                  <div class="bg-cardBg rounded-lg p-3 neon-border">
                    <div class="text-xs opacity-75 font-gaming">Total Score</div>
                    <div id="total-score" class="text-lg font-gaming font-bold text-purple">0</div>
                  </div>
                  <div class="bg-cardBg rounded-lg p-3 neon-border">
                    <div class="text-xs opacity-75 font-gaming">Questions</div>
                    <div id="total-questions" class="text-lg font-gaming font-bold text-gray-300">0</div>
                  </div>
                  <div class="bg-cardBg rounded-lg p-3 neon-border">
                    <div class="text-xs opacity-75 font-gaming">Max Combo</div>
                    <div id="max-combo" class="text-lg font-gaming font-bold text-primary">0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Grade/Level Bar -->
          <div class="bg-cardBg px-8 py-4 border-b border-primary/30">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="text-sm font-gaming font-medium text-primary">Level Progress</div>
                <div class="flex items-center gap-2">
                  <div id="level-badges" class="flex gap-1">
                    <!-- Level badges will be generated here -->
                  </div>
                </div>
              </div>
              <div class="text-right">
                <div class="text-sm text-gray-400 font-gaming">Total Play Time</div>
                <div id="total-playtime" class="font-gaming font-bold text-accent">0h 0m</div>
              </div>
            </div>
          </div>
          
          <!-- Main Content -->
          <div class="p-8 bg-cardBg">
            <div id="profile-content" class="space-y-8">
              <!-- Content will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
    
    <!-- Gaming Footer -->
    <footer class="relative z-10 bg-gradient-to-r from-dark to-light border-t-2 border-primary/30 py-12 mt-auto">
      <div class="max-w-6xl mx-auto px-6 text-center">
        <div class="flex items-center justify-center space-x-4 mb-6">
          <img src="public/assets/img/buko_productions-logo.png" alt="Buko Productions" class="w-16 h-16" />
          <div>
            <h3 class="font-gaming text-2xl font-bold text-primary">SCI-HIGH</h3>
            <p class="text-gray-400 text-sm">Level up your knowledge!</p>
          </div>
        </div>
        <div class="w-32 h-1 bg-gradient-to-r from-primary to-accent mx-auto rounded-full mb-6"></div>
        <p class="text-gray-400 font-gaming">&copy; 2025 SCI-HIGH Thesis Project. All rights reserved. Game on! üéÆ</p>
      </div>
    </footer>
    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD-Q2woACHgMCTVwd6aX-IUzLovE0ux-28",
        authDomain: "sci-high-website.firebaseapp.com",
        databaseURL: "https://sci-high-website-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sci-high-website",
        storageBucket: "sci-high-website.appspot.com",
        messagingSenderId: "451463202515",
        appId: "1:451463202515:web:e7f9c7bf69c04c685ef626"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // Helper function to format course names properly
      function formatCourseName(courseTopic) {
        if (!courseTopic || courseTopic === 'unknown') {
          return 'Unknown Course';
        }
        
        const courseMap = {
          'python': 'Python Programming',
          'java': 'Java Development',
          'csharp': 'C# Programming',
          'cpp': 'C++ Programming',
          'c': 'C Programming',
          'webdesign': 'Web Design'
        };
        
        return courseMap[courseTopic.toLowerCase()] || courseTopic.charAt(0).toUpperCase() + courseTopic.slice(1);
      }

      // Load Career Stats Data from Firebase
      async function loadCareerStatsData(filter = 'overall') {
        try {
          console.log('Loading career stats data with filter:', filter);
          
          // Get career stats data
          const careerSnapshot = await db.ref('student_career_stats').once('value');
          const careerData = careerSnapshot.val();
          
          if (!careerData) {
            console.log('No career stats data found');
            return [];
          }

          // Try to get main student data for correct names (fallback if permission denied)
          let studentNameMap = {};
          try {
            const studentsSnapshot = await db.ref('students').once('value');
            const studentsData = studentsSnapshot.val();
            
            if (studentsData) {
              Object.values(studentsData).forEach(student => {
                if (student.studentId) {
                  studentNameMap[student.studentId] = {
                    name: student.name || student.fullName || 'Unknown Student',
                    department: student.department || 'Unknown'
                  };
                }
              });
            }
          } catch (error) {
            console.warn('Could not access students database (permission denied), using career stats names:', error.message);
            // Continue without student names map - will use career stats names
          }

          // Use Map to accumulate data for students (to handle duplicates)
          const studentAccumulator = new Map();
          
          Object.entries(careerData).forEach(([studentId, statsData]) => {
            if (!statsData.careerStats || !statsData.studentInfo) {
              return; // Skip incomplete records
            }

            const career = statsData.careerStats;
            const info = statsData.studentInfo;
            
            // Get correct student name from main database, fallback to career stats
            const studentInfo = studentNameMap[studentId];
            
            // Enhanced name construction with better fallback logic
            let studentName = 'Unknown Student';
            
            if (studentInfo?.name) {
              // Use name from main students database
              studentName = studentInfo.name;
            } else if (info.fullName) {
              // Use fullName from career stats studentInfo
              studentName = info.fullName;
            } else if (statsData.firstName || statsData.lastName) {
              // Construct name from firstName and lastName, handling missing parts
              const firstName = statsData.firstName || '';
              const lastName = statsData.lastName || '';
              const middleName = statsData.middleName || '';
              
              if (firstName && lastName) {
                // If we have both first and last name
                studentName = middleName ? `${firstName} ${middleName} ${lastName}` : `${firstName} ${lastName}`;
              } else if (firstName) {
                // Only first name available
                studentName = firstName;
              } else if (lastName) {
                // Only last name available
                studentName = lastName;
              }
            } else if (statsData.studentInfo?.studentName) {
              // Check for alternative name field
              studentName = statsData.studentInfo.studentName;
            }
            
            // Ensure we don't have empty or just whitespace names
            studentName = studentName.trim() || `Student ${studentId}`;
            
            console.log(`Student ${studentId} name resolved as: "${studentName}"`, {
              fromMainDB: studentInfo?.name,
              fromCareerInfo: info.fullName,
              fromFirstLast: statsData.firstName + ' ' + statsData.lastName,
              final: studentName
            });
            
            // Determine department from main database first, then fallback
            let department = studentInfo?.department || statsData.department || 'Unknown';
            let departmentType = 'other';
            
            if (department) {
              departmentType = department.toLowerCase().includes('college') ? 'college' : 
                              department.toLowerCase().includes('senior') ? 'seniorhigh' : 
                              department.toLowerCase().includes('junior') ? 'juniorhigh' : 'other';
            }

            // Apply filter
            if (filter !== 'overall') {
              if (filter === 'college' && departmentType !== 'college') return;
              if (filter === 'seniorhigh' && departmentType !== 'seniorhigh') return;
              if (filter === 'juniorhigh' && departmentType !== 'juniorhigh') return;
            }

            // Use student name as key to accumulate data for same students
            const accumulatorKey = `${studentName}_${department}`.toLowerCase();
            
            if (studentAccumulator.has(accumulatorKey)) {
              // Accumulate existing student data
              const existing = studentAccumulator.get(accumulatorKey);
              
              // Add up scores and sessions
              existing.score += career.totalPoints || 0;
              existing.totalSessions += career.totalSessions || 0;
              
              // Calculate weighted average for accuracy
              const totalQuestions = existing.totalQuestions + (career.totalQuestions || 0);
              const totalCorrectAnswers = existing.totalCorrectAnswers + (career.totalCorrectAnswers || 0);
              existing.averageAccuracy = totalQuestions > 0 ? Math.round((totalCorrectAnswers / totalQuestions) * 100) : 0;
              existing.totalQuestions = totalQuestions;
              existing.totalCorrectAnswers = totalCorrectAnswers;
              
              // Keep highest streak
              existing.highestStreak = Math.max(existing.highestStreak, career.highestStreak || 0);
              
              // Merge course completion status
              const existingCompletion = existing.courseCompletionStatus;
              const newCompletion = career.courseCompletionStatus || {};
              Object.entries(newCompletion).forEach(([course, completed]) => {
                if (completed) existingCompletion[course] = true;
              });
              
              // Update completion percentage
              const totalCourses = Object.keys(existingCompletion).length;
              const completedCourses = Object.values(existingCompletion).filter(Boolean).length;
              existing.completedCourses = completedCourses;
              existing.totalCourses = totalCourses;
              existing.completionPercentage = totalCourses > 0 ? Math.round((completedCourses / totalCourses) * 100) : 0;
              
              // Update last updated time
              if (info.lastUpdated && (!existing.lastUpdated || new Date(info.lastUpdated) > new Date(existing.lastUpdated))) {
                existing.lastUpdated = info.lastUpdated;
              }
              
            } else {
              // First time seeing this student
              const completionStatus = career.courseCompletionStatus || {};
              const totalCourses = Object.keys(completionStatus).length;
              const completedCourses = Object.values(completionStatus).filter(Boolean).length;
              const completionPercentage = totalCourses > 0 ? Math.round((completedCourses / totalCourses) * 100) : 0;

              studentAccumulator.set(accumulatorKey, {
                studentId: studentId,
                userId: studentId, // For compatibility
                name: studentName,
                firstName: statsData.firstName || '',
                lastName: statsData.lastName || '',
                department: department,
                strandYear: statsData.strandYear || '',
                score: career.totalPoints || 0,
                totalSessions: career.totalSessions || 0,
                averageAccuracy: career.averageAccuracy || 0,
                totalQuestions: career.totalQuestions || 0,
                totalCorrectAnswers: career.totalCorrectAnswers || 0,
                highestStreak: career.highestStreak || 0,
                completedCourses: completedCourses,
                totalCourses: totalCourses,
                completionPercentage: completionPercentage,
                courseCompletionStatus: completionStatus,
                lastUpdated: info.lastUpdated || '',
                recentSessions: statsData.recentSessions || {}
              });
            }
          });

          // Convert Map back to array
          const leaderboardData = Array.from(studentAccumulator.values());

          // Sort by total accumulated points (descending)
          leaderboardData.sort((a, b) => b.score - a.score);
          
          console.log(`Loaded and consolidated ${leaderboardData.length} unique student records`);
          return leaderboardData;

        } catch (error) {
          console.error('Error loading career stats data:', error);
          return [];
        }
      }

      // Enhanced Leaderboard Rendering with Career Stats
      function renderLeaderboard(data) {
        const container = document.getElementById('leaderboard-list');
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center font-gaming">No career stats available yet. Complete some quiz sessions!</p>';
          return;
        }

        let html = `
          <div class="overflow-x-auto">
            <table class="w-full text-left bg-dark/50 rounded-lg overflow-hidden">
              <thead class="bg-gradient-to-r from-primary to-accent">
                <tr class="text-dark font-gaming">
                  <th class="py-4 px-4 font-bold">Rank</th>
                  <th class="py-4 px-4 font-bold">Student</th>
                  <th class="py-4 px-4 font-bold">Total Points</th>
                  <th class="py-4 px-4 font-bold">Sessions</th>
                  <th class="py-4 px-4 font-bold">Avg Accuracy</th>
                  <th class="py-4 px-4 font-bold">Courses</th>
                  <th class="py-4 px-4 font-bold">Department</th>
                </tr>
              </thead>
              <tbody>
        `;

        data.forEach((entry, index) => {
          const rank = index + 1;
          let rankBadge = '';
          let rowClass = 'border-b border-light/30 hover:bg-light/20 transition-colors';
          
          if (rank === 1) {
            rankBadge = 'üëë';
            rowClass += ' bg-gradient-to-r from-yellow-400/10 to-yellow-600/10';
          } else if (rank === 2) {
            rankBadge = 'ü•à';
            rowClass += ' bg-gradient-to-r from-gray-300/10 to-gray-500/10';
          } else if (rank === 3) {
            rankBadge = 'ü•â';
            rowClass += ' bg-gradient-to-r from-orange-400/10 to-orange-600/10';
          }

          const playerNameHtml = `
            <button class="player-name-link text-primary hover:text-accent underline cursor-pointer font-medium transition-colors" 
                    onclick="showPlayerProfile('${entry.studentId}')">
              ${entry.name}
            </button>
          `;

          const coursesHtml = `
            <div class="text-center">
              <span class="text-accent font-bold">${entry.completedCourses}/${entry.totalCourses}</span>
              <div class="text-xs text-gray-400">${entry.completionPercentage}%</div>
            </div>
          `;

          html += `
            <tr class="${rowClass}">
              <td class="py-3 px-4">
                <div class="flex items-center space-x-2">
                  <span class="font-gaming font-bold text-primary">#${rank}</span>
                  <span class="text-lg">${rankBadge}</span>
                </div>
              </td>
              <td class="py-3 px-4">
                <div>
                  ${playerNameHtml}
                  <div class="text-xs text-gray-400">
                    ${entry.strand ? `${entry.strand}` : ''}${entry.strand && entry.year ? ' - ' : ''}${entry.year ? `${entry.year}` : ''}${!entry.strand && !entry.year && entry.strandYear ? entry.strandYear : ''}
                  </div>
                </div>
              </td>
              <td class="py-3 px-4">
                <span class="font-gaming font-bold text-primary text-lg">${entry.score.toLocaleString()}</span>
              </td>
              <td class="py-3 px-4 text-center">
                <span class="font-gaming text-accent">${entry.totalSessions}</span>
              </td>
              <td class="py-3 px-4 text-center">
                <span class="font-gaming text-cyan">${entry.averageAccuracy}%</span>
              </td>
              <td class="py-3 px-4">
                ${coursesHtml}
              </td>
              <td class="py-3 px-4">
                <span class="text-sm text-gray-300">${entry.department}</span>
              </td>
            </tr>
          `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
      }

      // Enhanced Player Cards with Career Stats
      function renderPlayerCards(data) {
        console.log('renderPlayerCards called with career stats data:', data);
        const container = document.getElementById('player-cards-grid');
        const loading = document.getElementById('player-cards-loading');
        
        if (!container) {
          console.error('ERROR: player-cards-grid element not found!');
          return;
        }
        
        if (!data || data.length === 0) {
          console.log('No career stats data for cards');
          if (loading) {
            loading.innerHTML = '<p class="text-gray-400 text-center font-gaming">No students with career stats found</p>';
            loading.style.display = 'block';
          }
          return;
        }
        
        console.log('Rendering', Math.min(data.length, 3), 'career stats cards');
        // Hide loading and show cards
        if (loading) {
          loading.style.display = 'none';
        }
        
        // Take only top 3 players for featured cards
        const topPlayers = data.slice(0, 3);
        
        let cardsHtml = '';
        topPlayers.forEach((player, index) => {
          // Safe name handling
          let playerName = player.name || 'Unknown Student';
          
          // Safe initials generation
          let initials = '??';
          try {
            if (playerName && typeof playerName === 'string' && playerName.trim().length > 0) {
              const words = playerName.trim().split(' ').filter(word => word.length > 0);
              if (words.length > 0) {
                initials = words.map(word => word[0] ? word[0].toUpperCase() : '').join('').substring(0, 2);
                if (!initials || initials.length === 0) initials = playerName.substring(0, 2).toUpperCase();
              }
            }
          } catch (e) {
            console.warn('Error generating initials:', e);
            initials = '??';
          }
          
          // Special styling for each position
          let cardStyle, rankIcon, rankColor;
          if (index === 0) {
            cardStyle = 'from-yellow-400/20 to-yellow-600/20';
            rankIcon = 'üëë';
            rankColor = 'from-yellow-400 to-yellow-600';
          } else if (index === 1) {
            cardStyle = 'from-gray-300/20 to-gray-500/20';
            rankIcon = 'ü•à';
            rankColor = 'from-gray-300 to-gray-500';
          } else {
            cardStyle = 'from-orange-400/20 to-orange-600/20';
            rankIcon = 'ü•â';
            rankColor = 'from-orange-400 to-orange-600';
          }
          
          cardsHtml += `
            <div class="relative group cursor-pointer transform transition-all duration-300 hover:scale-105" onclick="showPlayerProfile('${player.studentId}')">
              <div class="neon-border bg-gradient-to-br ${cardStyle} rounded-lg p-6 backdrop-blur-sm relative overflow-hidden">
                <!-- Rank Badge -->
                <div class="absolute -top-3 -right-3 w-12 h-12 bg-gradient-to-br ${rankColor} rounded-full flex items-center justify-center text-lg font-bold text-white border-3 border-white shadow-xl z-10">
                  ${rankIcon}
                </div>
                
                <!-- Player Avatar -->
                <div class="flex flex-col items-center mb-4">
                  <div class="w-20 h-20 bg-gradient-to-br from-primary to-accent rounded-full flex items-center justify-center text-2xl font-bold text-dark mb-3 border-3 border-primary/50 shadow-lg">
                    ${initials}
                  </div>
                  <div class="text-center">
                    <h3 class="font-gaming text-primary text-lg font-bold">${playerName}</h3>
                    <p class="text-gray-400 text-sm">${player.department || 'Unknown'}</p>
                  </div>
                </div>
                
                <!-- Enhanced Player Stats -->
                <div class="space-y-3">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-300 text-sm font-gaming">Career Points</span>
                    <span class="text-primary font-gaming font-bold text-lg">${(player.score || 0).toLocaleString()}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-300 text-sm font-gaming">Global Rank</span>
                    <span class="text-accent font-gaming font-bold text-lg">#${index + 1}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-300 text-sm font-gaming">Sessions</span>
                    <span class="text-cyan font-gaming font-bold">${player.totalSessions || 0}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-300 text-sm font-gaming">Accuracy</span>
                    <span class="text-purple font-gaming font-bold">${player.averageAccuracy || 0}%</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-300 text-sm font-gaming">Courses</span>
                    <span class="text-orange-400 font-gaming font-bold">${player.completedCourses}/${player.totalCourses}</span>
                  </div>
                </div>
                
                <!-- Course Progress Bar -->
                <div class="mt-4">
                  <div class="flex justify-between text-xs text-gray-400 mb-1">
                    <span>Course Progress</span>
                    <span>${player.completionPercentage}%</span>
                  </div>
                  <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="bg-gradient-to-r from-accent to-cyan h-2 rounded-full transition-all duration-300" style="width: ${player.completionPercentage}%"></div>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = cardsHtml;
      }

      // Enhanced Fetch Leaderboard using Career Stats
      async function fetchLeaderboard(filter) {
        try {
          console.log('Starting fetchLeaderboard with filter:', filter);
          
          // Load career stats data using the new function
          const careerStatsData = await loadCareerStatsData(filter);
          
          console.log(`Loaded ${careerStatsData.length} career stats entries for filter:`, filter);
          
          // Render results
          console.log('Calling renderPlayerCards with top 3...');
          renderPlayerCards(careerStatsData.slice(0, 3));
          
          console.log('Calling renderLeaderboard with career stats data...');
          renderLeaderboard(careerStatsData);
          
        } catch (error) {
          console.error('Error fetching career stats leaderboard:', error);
          console.error('Error details:', error.message);
          
          // Show error message
          const leaderboardList = document.getElementById('leaderboard-list');
          if (leaderboardList) {
            leaderboardList.innerHTML = `<div class="text-center py-8 text-red-400">‚ö†Ô∏è Database error: ${error.message}</div>`;
          }
          
          // Show error in player cards
          const loading = document.getElementById('player-cards-loading');
          if (loading) {
            loading.innerHTML = `<p class="text-red-400 text-center font-gaming">Database Error: ${error.message}</p>`;
            loading.style.display = 'block';
          }
        }
      }

      // Filter button logic
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('bg-primary', 'text-dark'));
          this.classList.add('bg-primary', 'text-dark');
          fetchLeaderboard(this.dataset.filter);
        });
      });

      // Initial load: overall
      fetchLeaderboard('overall');

      // Add missing functions for leaderboard API
      async function addScore(userId, playerName, score, department = 'Unknown', gameData = {}) {
        try {
          const scoreData = {
            name: playerName,
            score: score,
            department: department,
            timestamp: Date.now(),
            submissionDate: new Date().toISOString(),
            gameData: gameData
          };

          await db.ref('leaderboards/' + userId).set(scoreData);
          console.log('Score added successfully:', scoreData);
          return { success: true, data: scoreData };
        } catch (error) {
          console.error('Error adding score:', error);
          throw error;
        }
      }

      async function updateBestScore(userId, playerName, score, department = 'Unknown', gameData = {}) {
        try {
          const snapshot = await db.ref('leaderboards/' + userId).once('value');
          const existingData = snapshot.val();
          
          if (!existingData || score > existingData.score) {
            await addScore(userId, playerName, score, department, gameData);
            return { 
              success: true, 
              isNewBest: true, 
              previousBest: existingData ? existingData.score : 0,
              newBest: score
            };
          } else {
            return {
              success: true,
              isNewBest: false,
              currentBest: existingData.score,
              submittedScore: score
            };
          }
        } catch (error) {
          console.error('Error updating best score:', error);
          throw error;
        }
      }

      async function getPlayerBestScore(userId) {
        try {
          const snapshot = await db.ref('leaderboards/' + userId).once('value');
          const data = snapshot.val();
          return data ? data.score : 0;
        } catch (error) {
          console.error('Error getting player best score:', error);
          return 0;
        }
      }

      // Make functions globally accessible for game integration
      window.leaderboardAPI = {
        addScore,
        updateBestScore,
        getPlayerBestScore,
        fetchLeaderboard
      };

      // Enhanced Player Profile with Career Stats
      async function showPlayerProfile(userId) {
        console.log('Loading career stats profile for user:', userId);
        
        // Show modal with animation
        const modal = document.getElementById('player-profile-modal');
        modal.classList.remove('hidden');
        
        // Add modal enter animation to the modal content
        const modalContent = modal.querySelector('.neon-border');
        if (modalContent) {
          modalContent.classList.add('modal-enter');
        }
        
        // Show loading state
        document.getElementById('profile-content').innerHTML = `
          <div class="text-center py-8">
            <div class="flex flex-col items-center space-y-4">
              <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
              <p class="text-gray-300 font-gaming">Loading warrior profile...</p>
            </div>
          </div>
        `;
        
        try {
          // Fetch career stats data
          const careerStatsSnapshot = await db.ref('student_career_stats/' + userId).once('value');
          const careerStatsData = careerStatsSnapshot.val();
          
          if (careerStatsData && careerStatsData.careerStats && careerStatsData.studentInfo) {
            await renderPlayerProfileWithCareerStats(careerStatsData, userId);
          } else {
            document.getElementById('profile-content').innerHTML = `
              <div class="text-center py-8">
                <div class="text-red-400 font-gaming text-lg">‚ö†Ô∏è Career stats not found</div>
                <p class="text-gray-400 mt-2">This student might not have completed any quiz sessions yet.</p>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error loading career stats profile:', error);
          document.getElementById('profile-content').innerHTML = `
            <div class="text-center py-8">
              <div class="text-red-400 font-gaming text-lg">‚ö†Ô∏è Error loading profile</div>
              <p class="text-gray-400 mt-2">${error.message}</p>
            </div>
          `;
        }
      }

      function closePlayerProfile() {
        document.getElementById('player-profile-modal').classList.add('hidden');
      }

      // Function to calculate player rankings
      async function calculatePlayerRankings(studentId, currentPlayerScore, currentPlayerDepartment) {
        try {
          // Load all career stats data for ranking calculation
          const allCareerStatsData = await loadCareerStatsData('overall');
          
          // Calculate global rank
          const globalRank = allCareerStatsData.findIndex(player => player.studentId === studentId) + 1;
          
          // Calculate department rank
          const departmentPlayers = allCareerStatsData.filter(player => 
            player.department === currentPlayerDepartment
          );
          const departmentRank = departmentPlayers.findIndex(player => player.studentId === studentId) + 1;
          
          return {
            globalRank: globalRank > 0 ? globalRank : '?',
            departmentRank: departmentRank > 0 ? departmentRank : '?'
          };
        } catch (error) {
          console.error('Error calculating rankings:', error);
          return {
            globalRank: '?',
            departmentRank: '?'
          };
        }
      }

      // New Enhanced Player Profile with Career Stats
      async function renderPlayerProfileWithCareerStats(careerStatsData, studentId) {
        const career = careerStatsData.careerStats;
        const info = careerStatsData.studentInfo;
        const recentSessions = careerStatsData.recentSessions || {};
        
        // Generate avatar initials
        let initials = '??';
        const fullName = info.fullName || 'Unknown Student';
        if (fullName && fullName.trim().length > 0) {
          const words = fullName.trim().split(' ').filter(word => word.length > 0);
          if (words.length > 0) {
            initials = words.map(word => word[0] ? word[0].toUpperCase() : '').join('').substring(0, 2);
          }
        }
        
        // Calculate course completion stats
        const completionStatus = career.courseCompletionStatus || {};
        const totalCourses = Object.keys(completionStatus).length;
        const completedCourses = Object.values(completionStatus).filter(Boolean).length;
        const completionPercentage = totalCourses > 0 ? Math.round((completedCourses / totalCourses) * 100) : 0;
        
        // Format department display
        let department = 'Unknown';
        if (careerStatsData.department) {
          department = careerStatsData.department;
        }
        
        // Update header information
        document.getElementById('player-avatar').textContent = initials;
        document.getElementById('profile-player-name').textContent = fullName;
        document.getElementById('profile-department').innerHTML = `
          <span class="inline-block w-6 h-4 bg-primary rounded shadow"></span>
          ${department}
        `;
        
        // Calculate and update rankings dynamically
        const rankings = await calculatePlayerRankings(studentId, career.totalPoints || 0, department);
        document.getElementById('global-rank').textContent = '#' + rankings.globalRank;
        document.getElementById('dept-rank').textContent = '#' + rankings.departmentRank;
        
        // Update stats with career data
        document.getElementById('ranked-score').textContent = (career.totalPoints || 0).toLocaleString();
        document.getElementById('accuracy').textContent = (career.averageAccuracy || 0).toFixed(1) + '%';
        document.getElementById('quiz-count').textContent = career.totalSessions || 0;
        document.getElementById('total-score').textContent = (career.totalPoints || 0).toLocaleString();
        document.getElementById('total-questions').textContent = career.totalQuestions || 0;
        document.getElementById('max-combo').textContent = career.highestStreak || 0;
        document.getElementById('total-playtime').textContent = formatPlayTime(career.totalPlayTime || 0);
        
        // Generate level badges based on career achievements
        generateLevelBadges(career.totalSessions || 0);
        
        // Create enhanced profile content with career stats
        const content = document.getElementById('profile-content');
        content.innerHTML = `
          <!-- Course Completion Progress -->
          <div class="bg-cardBg p-6 rounded-lg neon-border">
            <h3 class="text-xl font-bold text-primary mb-4 flex items-center gap-2 font-gaming">
              <span class="text-primary">üéì</span>
              Course Completion Progress
            </h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-4">
              ${generateCourseCompletionBadges(completionStatus)}
            </div>
            <div class="mt-4">
              <div class="flex justify-between text-sm text-gray-400 mb-2">
                <span>Overall Progress</span>
                <span>${completedCourses}/${totalCourses} courses (${completionPercentage}%)</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-3">
                <div class="bg-gradient-to-r from-accent to-cyan h-3 rounded-full transition-all duration-300" style="width: ${completionPercentage}%"></div>
              </div>
            </div>
          </div>

          <!-- Career Statistics Overview -->
          <div class="grid lg:grid-cols-2 gap-6">
            <!-- Career Performance Chart -->
            <div class="bg-cardBg p-6 rounded-lg neon-border">
              <h3 class="text-lg font-semibold text-accent mb-4 font-gaming">Career Performance</h3>
              <div class="relative h-64 mb-4 bg-dark/50 rounded-lg flex items-center justify-center overflow-hidden">
                <canvas id="careerChart" class="max-w-full max-h-full"></canvas>
                <div id="careerChartFallback" class="text-gray-400 text-center absolute inset-0 flex flex-col items-center justify-center">
                  <div class="text-4xl mb-2">üìà</div>
                  <div>Loading performance chart...</div>
                </div>
              </div>
              <div class="text-sm text-gray-300 text-center">
                Total Sessions: ${career.totalSessions || 0} ‚Ä¢ Best Streak: ${career.highestStreak || 0}
              </div>
            </div>

            <!-- Recent Session Activity -->
            <div class="bg-cardBg p-6 rounded-lg neon-border">
              <h3 class="text-lg font-semibold text-cyan mb-4 font-gaming">Recent Activity</h3>
              <div class="space-y-3 max-h-64 overflow-y-auto">
                ${generateRecentSessionsDisplay(recentSessions)}
              </div>
            </div>
          </div>

          <!-- Detailed Career Statistics -->
          <div class="grid lg:grid-cols-2 gap-6">
            <!-- Performance Metrics -->
            <div class="bg-cardBg p-6 rounded-lg neon-border">
              <h3 class="text-lg font-semibold text-purple mb-4 font-gaming">Performance Metrics</h3>
              <div class="relative h-64 mb-4 bg-dark/50 rounded-lg flex items-center justify-center overflow-hidden">
                <canvas id="performanceRadar" class="max-w-full max-h-full"></canvas>
                <div id="radarChartFallback" class="text-gray-400 text-center absolute inset-0 flex flex-col items-center justify-center">
                  <div class="text-4xl mb-2">üéØ</div>
                  <div>Loading skill assessment...</div>
                </div>
              </div>
              <div class="text-sm text-gray-300 text-center">
                Comprehensive skill assessment
              </div>
            </div>

            <!-- Course Progress Breakdown -->
            <div class="bg-cardBg p-6 rounded-lg neon-border">
              <h3 class="text-lg font-semibold text-primary mb-4 font-gaming">Course Progress</h3>
              <div class="space-y-3">
                ${generateCourseProgressBars(completionStatus, career)}
              </div>
            </div>
          </div>

          <!-- Career Summary -->
          <div class="bg-cardBg p-6 rounded-lg neon-border">
            <h3 class="text-lg font-semibold text-cyan mb-4 font-gaming">Career Summary</h3>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="bg-dark/50 p-4 rounded text-center neon-border">
                <div class="text-2xl font-bold text-primary font-gaming">${(career.totalPoints || 0).toLocaleString()}</div>
                <div class="text-sm text-gray-400">Total Points</div>
              </div>
              <div class="bg-dark/50 p-4 rounded text-center neon-border">
                <div class="text-2xl font-bold text-accent font-gaming">${career.totalSessions || 0}</div>
                <div class="text-sm text-gray-400">Total Sessions</div>
              </div>
              <div class="bg-dark/50 p-4 rounded text-center neon-border">
                <div class="text-2xl font-bold text-cyan font-gaming">${(career.averageAccuracy || 0).toFixed(1)}%</div>
                <div class="text-sm text-gray-400">Average Accuracy</div>
              </div>
              <div class="bg-dark/50 p-4 rounded text-center neon-border">
                <div class="text-2xl font-bold text-purple font-gaming">${career.highestStreak || 0}</div>
                <div class="text-sm text-gray-400">Best Streak</div>
              </div>
            </div>
          </div>
        `;
        
        // Initialize charts with career stats data
        setTimeout(() => {
          console.log('‚è∞ Chart initialization timeout triggered');
          console.log('üìä Chart data check - career:', career);
          console.log('‚úÖ Chart data check - completionStatus:', completionStatus);
          initializeCareerStatsCharts(career, completionStatus, recentSessions);
        }, 100);
      }

      function renderPlayerProfile(playerData) {
        // Restore sanitized Firebase keys if they exist
        const gameData = playerData.gameData || {};
        const topicPoints = restoreFirebaseKeys(gameData.topicPoints || {});
        
        // Calculate additional stats
        const submissionDate = playerData.submissionDate ? new Date(playerData.submissionDate).toLocaleDateString() : 'Unknown';
        const playTimeFormatted = formatPlayTime(gameData.playTime || 0);
        
        // Calculate derived statistics
        const totalTopicPoints = Object.values(topicPoints).reduce((sum, points) => sum + points, 0);
        const averageTopicScore = totalTopicPoints > 0 ? Math.round(totalTopicPoints / Object.keys(topicPoints).length) : 0;
        const estimatedQuizCount = Math.floor(totalTopicPoints / 100) || 1; // Estimate based on points
        const estimatedTotalQuestions = estimatedQuizCount * 10; // Estimate 10 questions per quiz
        const estimatedAccuracy = Math.min(95, Math.max(60, 70 + (playerData.score / 100))); // Estimate accuracy
        const maxCombo = Math.floor(playerData.score / 50) || 1; // Estimate max combo
        
        // Generate avatar initials
        const initials = playerData.name.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
        
        // Update header information
        document.getElementById('player-avatar').textContent = initials;
        document.getElementById('profile-player-name').textContent = playerData.name;
        document.getElementById('profile-department').innerHTML = `
          <span class="inline-block w-6 h-4 bg-primary rounded shadow"></span>
          ${playerData.department || 'Unknown'}
        `;
        
        // Update rankings (calculate proper rankings based on score)
        // For now, use a simple approximation until we can get proper user ID
        const estimatedGlobalRank = Math.max(1, Math.floor((5000 - playerData.score) / 10) + 1);
        const estimatedDeptRank = Math.max(1, Math.floor((2000 - playerData.score) / 15) + 1);
        document.getElementById('global-rank').textContent = '#' + estimatedGlobalRank;
        document.getElementById('dept-rank').textContent = '#' + estimatedDeptRank;
        
        // Update stats
        document.getElementById('ranked-score').textContent = playerData.score.toLocaleString();
        document.getElementById('accuracy').textContent = estimatedAccuracy.toFixed(1) + '%';
        document.getElementById('quiz-count').textContent = estimatedQuizCount;
        document.getElementById('total-score').textContent = (gameData.totalPoints || playerData.score).toLocaleString();
        document.getElementById('total-questions').textContent = estimatedTotalQuestions;
        document.getElementById('max-combo').textContent = maxCombo;
        document.getElementById('total-playtime').textContent = playTimeFormatted;
        
        // Generate level badges
        generateLevelBadges(gameData.achievementCount || 0);
        
        // Update main content area
        const content = document.getElementById('profile-content');
        content.innerHTML = `
          <!-- Badges Section -->
          <div class="bg-cardBg p-6 rounded-lg neon-border">
            <h3 class="text-xl font-bold text-primary mb-4 flex items-center gap-2 font-gaming">
              <span class="text-primary">üèÜ</span>
              Badges & Achievements
            </h3>
            <div id="badges-container" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4 min-h-[100px]">
              ${generateAchievementBadges(gameData.achievementCount || 0)}
            </div>
            ${(gameData.achievementCount || 0) === 0 ? '<p class="text-gray-400 text-center mt-4">No badges earned yet. Keep playing to unlock achievements!</p>' : ''}
          </div>

          <!-- Performance Charts Section -->
          <div class="grid lg:grid-cols-2 gap-6">
            <!-- Topic Performance Chart -->
            <div class="bg-cardBg p-6 rounded-lg neon-border">
              <h3 class="text-lg font-semibold text-accent mb-4 font-gaming">Topic Performance</h3>
              ${Object.keys(topicPoints).length > 0 ? `
                <div class="relative h-64 mb-4 bg-white rounded-lg p-4">
                  <canvas id="topicChart"></canvas>
                </div>
                <div class="text-sm text-gray-300 text-center">
                  Best Topic: ${getBestTopic(topicPoints)} ‚Ä¢ Average: ${averageTopicScore} pts
                </div>
              ` : `
                <div class="h-64 flex items-center justify-center text-gray-400">
                  <div class="text-center">
                    <div class="text-4xl mb-2">üìä</div>
                    <div>No topic data available</div>
                  </div>
                </div>
              `}
            </div>

            <!-- Score Analysis Chart -->
            <div class="bg-cardBg p-6 rounded-lg neon-border">
              <h3 class="text-lg font-semibold text-cyan mb-4 font-gaming">Score Analysis</h3>
              <div class="relative h-64 mb-4 bg-white rounded-lg p-4">
                <canvas id="scoreChart"></canvas>
              </div>
              <div class="text-sm text-gray-300 text-center">
                Total Contribution Analysis
              </div>
            </div>
          </div>

          <!-- Detailed Statistics -->
          <div class="grid lg:grid-cols-2 gap-6">
            <!-- Performance Metrics -->
            <div class="bg-cardBg p-6 rounded-lg neon-border">
              <h3 class="text-lg font-semibold text-purple mb-4 font-gaming">Performance Radar</h3>
              <div class="relative h-64 mb-4 bg-white rounded-lg p-4">
                <canvas id="radarChart"></canvas>
              </div>
              <div class="text-sm text-gray-300 text-center">
                Overall performance across all metrics
              </div>
            </div>

            <!-- Course Progress -->
            ${gameData.courseProgress ? `
            <div class="bg-cardBg p-6 rounded-lg neon-border">
              <h3 class="text-lg font-semibold text-primary mb-4 font-gaming">Course Progress</h3>
              <div class="relative h-64 mb-4 bg-white rounded-lg p-4">
                <canvas id="progressChart"></canvas>
              </div>
              <div class="text-sm text-gray-300 text-center">
                ${formatCourseProgress(gameData.courseProgress)}
              </div>
            </div>
            ` : `
            <div class="bg-cardBg p-6 rounded-lg neon-border">
              <h3 class="text-lg font-semibold text-accent mb-4 font-gaming">Recent Activity</h3>
              <div class="space-y-3">
                <div class="flex items-center gap-3 p-3 bg-dark/50 rounded neon-border">
                  <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-dark font-bold">
                    ${playerData.score >= 1000 ? 'S' : playerData.score >= 500 ? 'A' : 'B'}
                  </div>
                  <div>
                    <div class="font-medium text-primary">Best Score Achieved</div>
                    <div class="text-sm text-gray-400">${submissionDate} ‚Ä¢ ${playerData.score} points</div>
                  </div>
                </div>
                <div class="text-center text-gray-400 mt-4">
                  More activity data will appear as you play more games!
                </div>
              </div>
            </div>
            `}
          </div>

          <!-- Topic Breakdown Table -->
          ${Object.keys(topicPoints).length > 0 ? `
          <div class="bg-cardBg p-6 rounded-lg neon-border">
            <h3 class="text-lg font-semibold text-primary mb-4 font-gaming">Topic Performance Breakdown</h3>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b border-primary/30">
                    <th class="text-left py-2 px-4 text-primary font-gaming">Topic</th>
                    <th class="text-center py-2 px-4 text-accent font-gaming">Score</th>
                    <th class="text-center py-2 px-4 text-cyan font-gaming">Percentage</th>
                    <th class="text-center py-2 px-4 text-purple font-gaming">Rank</th>
                  </tr>
                </thead>
                <tbody>
                  ${Object.entries(topicPoints)
                    .sort(([,a], [,b]) => b - a)
                    .map(([topic, points], index) => `
                    <tr class="border-b border-primary/20 hover:bg-dark/30">
                      <td class="py-3 px-4">
                        <div class="flex items-center gap-2">
                          <div class="w-3 h-3 rounded-full" style="background-color: ${getTopicColor(topic)}"></div>
                          <span class="font-medium text-gray-200">${formatTopicName(topic)}</span>
                        </div>
                      </td>
                      <td class="text-center py-3 px-4 font-bold text-primary">${points}</td>
                      <td class="text-center py-3 px-4 text-gray-300">${((points / totalTopicPoints) * 100).toFixed(1)}%</td>
                      <td class="text-center py-3 px-4">
                        <span class="inline-block px-2 py-1 rounded text-sm ${index === 0 ? 'bg-primary/20 text-primary' : index < 3 ? 'bg-accent/20 text-accent' : 'bg-gray-600/20 text-gray-300'}">
                          #${index + 1}
                        </span>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
          ` : ''}

          <!-- Player Statistics Summary -->
          <div class="bg-cardBg p-6 rounded-lg neon-border">
            <h3 class="text-lg font-semibold text-cyan mb-4 font-gaming">Player Summary</h3>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="bg-dark/50 p-4 rounded text-center neon-border">
                <div class="text-2xl font-bold text-primary font-gaming">${playerData.score}</div>
                <div class="text-sm text-gray-400">Highest Score</div>
              </div>
              <div class="bg-dark/50 p-4 rounded text-center neon-border">
                <div class="text-2xl font-bold text-accent font-gaming">${gameData.achievementCount || 0}</div>
                <div class="text-sm text-gray-400">Achievements</div>
              </div>
              <div class="bg-dark/50 p-4 rounded text-center neon-border">
                <div class="text-2xl font-bold text-cyan font-gaming">${Object.keys(topicPoints).length}</div>
                <div class="text-sm text-gray-400">Topics Mastered</div>
              </div>
              <div class="bg-dark/50 p-4 rounded text-center neon-border">
                <div class="text-2xl font-bold text-purple font-gaming">${playTimeFormatted}</div>
                <div class="text-sm text-gray-400">Time Invested</div>
              </div>
            </div>
          </div>
        `;

        // Create charts after DOM is updated
        setTimeout(() => {
          createPlayerCharts(playerData, topicPoints, gameData);
        }, 100);
      }

      // Chart Creation Functions

      function createPlayerCharts(playerData, topicPoints, gameData) {
        // Create Topic Performance Chart (Doughnut)
        if (Object.keys(topicPoints).length > 0) {
          createTopicChart(topicPoints);
        }

        // Create Score Analysis Chart (Bar)
        createScoreChart(playerData, gameData);

        // Create Course Progress Chart (if data available)
        if (gameData.courseProgress) {
          createProgressChart(gameData.courseProgress);
        }

        // Create Performance Radar Chart
        createRadarChart(playerData, gameData, topicPoints);
      }

      function createTopicChart(topicPoints) {
        const ctx = document.getElementById('topicChart');
        if (!ctx) return;

        const topics = Object.keys(topicPoints);
        const scores = Object.values(topicPoints);
        
        // Generate colors for each topic
        const colors = generateChartColors(topics.length);

        const chart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: topics.map(topic => formatTopicName(topic)),
            datasets: [{
              data: scores,
              backgroundColor: colors.backgrounds,
              borderColor: colors.borders,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 15,
                  usePointStyle: true
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} pts (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }

      function createScoreChart(playerData, gameData) {
        const ctx = document.getElementById('scoreChart');
        if (!ctx) return;

        // Create score breakdown data
        const totalScore = playerData.score;
        const achievementBonus = (gameData.achievementCount || 0) * 100; // Estimate
        const baseScore = totalScore - achievementBonus;
        const timeBonus = Math.max(0, totalScore * 0.1); // Estimate

        const chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Base Score', 'Achievement Bonus', 'Time Bonus'],
            datasets: [{
              label: 'Score Breakdown',
              data: [baseScore, achievementBonus, timeBonus],
              backgroundColor: [
                'rgba(244, 206, 20, 0.8)',   // primary
                'rgba(55, 151, 119, 0.8)',   // accent
                'rgba(69, 71, 75, 0.8)'      // dark
              ],
              borderColor: [
                'rgb(244, 206, 20)',
                'rgb(55, 151, 119)',
                'rgb(69, 71, 75)'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.label}: ${context.parsed.y} points`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Points'
                }
              }
            }
          }
        });
      }

      function createProgressChart(courseProgress) {
        const ctx = document.getElementById('progressChart');
        if (!ctx) return;

        const courses = Object.keys(courseProgress);
        const completed = courses.map(course => courseProgress[course] ? 1 : 0);
        
        const chart = new Chart(ctx, {
          type: 'polarArea',
          data: {
            labels: courses.map(course => formatCourseName(course)),
            datasets: [{
              data: completed,
              backgroundColor: completed.map(status => 
                status ? 'rgba(55, 151, 119, 0.7)' : 'rgba(231, 76, 60, 0.7)'
              ),
              borderColor: completed.map(status => 
                status ? 'rgb(55, 151, 119)' : 'rgb(231, 76, 60)'
              ),
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 10,
                  usePointStyle: true
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const status = context.parsed ? 'Completed' : 'In Progress';
                    return `${context.label}: ${status}`;
                  }
                }
              }
            },
            scales: {
              r: {
                display: false
              }
            }
          }
        });
      }

      function createRadarChart(playerData, gameData, topicPoints) {
        const ctx = document.getElementById('radarChart');
        if (!ctx) return;

        // Normalize values to 0-10 scale for radar chart
        const maxScore = Math.max(playerData.score, 1000);
        const maxAchievements = Math.max(gameData.achievementCount || 1, 10);
        const maxPlayTime = Math.max(gameData.playTime || 1, 7200); // 2 hours max
        const maxTopics = Math.max(Object.keys(topicPoints).length, 6);

        const normalizedScore = (playerData.score / maxScore) * 10;
        const normalizedAchievements = ((gameData.achievementCount || 0) / maxAchievements) * 10;
        const normalizedPlayTime = ((gameData.playTime || 0) / maxPlayTime) * 10;
        const normalizedTopics = (Object.keys(topicPoints).length / maxTopics) * 10;
        const normalizedConsistency = Object.keys(topicPoints).length > 0 ? 
          (Math.min(...Object.values(topicPoints)) / Math.max(...Object.values(topicPoints))) * 10 : 0;

        const chart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: ['Score', 'Achievements', 'Experience', 'Diversity', 'Consistency'],
            datasets: [{
              label: 'Performance Metrics',
              data: [normalizedScore, normalizedAchievements, normalizedPlayTime, normalizedTopics, normalizedConsistency],
              backgroundColor: 'rgba(244, 206, 20, 0.2)',
              borderColor: 'rgb(244, 206, 20)',
              borderWidth: 2,
              pointBackgroundColor: 'rgb(244, 206, 20)',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: 'rgb(244, 206, 20)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              r: {
                beginAtZero: true,
                max: 10,
                ticks: {
                  display: false
                }
              }
            }
          }
        });
      }

      // Utility Functions for Charts
      function generateChartColors(count) {
        const baseColors = [
          { bg: 'rgba(244, 206, 20, 0.8)', border: 'rgb(244, 206, 20)' },   // primary
          { bg: 'rgba(55, 151, 119, 0.8)', border: 'rgb(55, 151, 119)' },   // accent
          { bg: 'rgba(69, 71, 75, 0.8)', border: 'rgb(69, 71, 75)' },       // dark
          { bg: 'rgba(52, 152, 219, 0.8)', border: 'rgb(52, 152, 219)' },   // blue
          { bg: 'rgba(155, 89, 182, 0.8)', border: 'rgb(155, 89, 182)' },   // purple
          { bg: 'rgba(231, 76, 60, 0.8)', border: 'rgb(231, 76, 60)' },     // red
        ];

        const backgrounds = [];
        const borders = [];

        for (let i = 0; i < count; i++) {
          const colorIndex = i % baseColors.length;
          backgrounds.push(baseColors[colorIndex].bg);
          borders.push(baseColors[colorIndex].border);
        }

        return { backgrounds, borders };
      }

      function formatCourseName(course) {
        return course.replace(/_/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());
      }

      // Additional helper functions for osu!-style profile
      function generateLevelBadges(achievementCount) {
        const levelContainer = document.getElementById('level-badges');
        levelContainer.innerHTML = '';
        
        // Generate level badges based on achievement count
        const levels = ['D', 'C', 'B', 'A', 'S', 'SS'];
        const currentLevel = Math.min(Math.floor(achievementCount / 2), levels.length - 1);
        
        for (let i = 0; i <= currentLevel; i++) {
          const badge = document.createElement('div');
          badge.className = `w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold ${
            i === currentLevel ? 'bg-primary' : 'bg-accent'
          }`;
          badge.textContent = levels[i];
          levelContainer.appendChild(badge);
        }
      }

      function generateAchievementBadges(achievementCount) {
        if (achievementCount === 0) {
          return `
            <div class="col-span-full flex items-center justify-center py-8 text-gray-400">
              <div class="text-center">
                <div class="text-4xl mb-2">üèÜ</div>
                <div>No badges yet</div>
                <div class="text-sm">Complete challenges to earn badges!</div>
              </div>
            </div>
          `;
        }

        const badges = [
          { name: 'First Steps', icon: 'üë∂', description: 'Completed first quiz', color: 'bg-blue-500' },
          { name: 'Dedicated', icon: '‚è∞', description: 'Played for 1 hour', color: 'bg-green-500' },
          { name: 'Scholar', icon: 'üìö', description: 'Earned 1000 points', color: 'bg-purple-500' },
          { name: 'Combo Master', icon: 'üî•', description: 'Achieved 50+ combo', color: 'bg-red-500' },
          { name: 'Multi-talented', icon: 'üåü', description: 'Mastered 3+ topics', color: 'bg-yellow-500' },
          { name: 'Perfectionist', icon: 'üíØ', description: 'Perfect quiz score', color: 'bg-pink-500' },
          { name: 'Speed Demon', icon: '‚ö°', description: 'Lightning fast answers', color: 'bg-indigo-500' },
          { name: 'Persistent', icon: 'üí™', description: 'Completed 10+ quizzes', color: 'bg-teal-500' },
          { name: 'Top Scorer', icon: 'üèÜ', description: 'Reached leaderboard top 10', color: 'bg-orange-500' },
          { name: 'Legend', icon: 'üëë', description: 'Ultimate achievement', color: 'bg-gradient-to-r from-yellow-400 to-orange-500' }
        ];

        let badgeHTML = '';
        const earnedBadges = badges.slice(0, Math.min(achievementCount, badges.length));
        
        earnedBadges.forEach(badge => {
          badgeHTML += `
            <div class="group relative">
              <div class="w-16 h-16 ${badge.color} rounded-lg flex items-center justify-center text-white text-2xl shadow-lg transform transition-transform group-hover:scale-110 cursor-pointer">
                ${badge.icon}
              </div>
              <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                <div class="font-bold">${badge.name}</div>
                <div>${badge.description}</div>
              </div>
            </div>
          `;
        });

        // Add placeholder badges for future achievements
        const remainingSlots = Math.max(0, 6 - earnedBadges.length);
        for (let i = 0; i < remainingSlots; i++) {
          badgeHTML += `
            <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center text-gray-400 text-xl border-2 border-dashed border-gray-300">
              üîí
            </div>
          `;
        }

        return badgeHTML;
      }

      function getBestTopic(topicPoints) {
        if (Object.keys(topicPoints).length === 0) return 'None';
        const [bestTopic] = Object.entries(topicPoints).reduce((a, b) => a[1] > b[1] ? a : b);
        return formatTopicName(bestTopic);
      }

      function getTopicColor(topic) {
        const colors = {
          'python': '#3776ab',
          'java': '#f89820',
          'C': '#00599c',
          'C++': '#00599c',
          'C_plus_plus_': '#00599c',
          'C#': '#239120',
          'C_sharp_': '#239120',
          'csharp': '#239120',
          'webdesign': '#e34c26',
          'webDesign': '#e34c26',
          'javascript': '#f7df1e',
          'html': '#e34c26',
          'css': '#1572b6'
        };
        return colors[topic] || '#6b7280';
      }
      function restoreFirebaseKeys(obj) {
        if (!obj || typeof obj !== 'object') return {};
        
        const restored = {};
        for (const [key, value] of Object.entries(obj)) {
          const restoredKey = key
            .replace(/_sharp_/g, '#')
            .replace(/_plus_/g, '+')
            .replace(/_dot_/g, '.')
            .replace(/_dollar_/g, '$')
            .replace(/_slash_/g, '/')
            .replace(/_lbracket_/g, '[')
            .replace(/_rbracket_/g, ']');
          
          restored[restoredKey] = value;
        }
        return restored;
      }

      function formatTopicName(topic) {
        // Convert topic names to readable format
        const topicMap = {
          'C': 'C Programming',
          'C++': 'C++',
          'C#': 'C#',
          'csharp': 'C#',
          'java': 'Java',
          'python': 'Python',
          'webdesign': 'Web Design',
          'webDesign': 'Web Design'
        };
        return topicMap[topic] || topic.charAt(0).toUpperCase() + topic.slice(1);
      }

      function formatPlayTime(seconds) {
        if (!seconds || seconds === 0) return 'No data';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        
        if (hours > 0) {
          return `${hours}h ${minutes}m`;
        } else if (minutes > 0) {
          return `${minutes}m`;
        } else {
          return `${seconds}s`;
        }
      }

      function formatCourseProgress(progress) {
        if (!progress || typeof progress !== 'object') return 'No data';
        
        const completed = Object.values(progress).filter(Boolean).length;
        const total = Object.keys(progress).length;
        
        if (total === 0) return 'No data';
        
        const percentage = Math.round((completed / total) * 100);
        return `${completed}/${total} courses (${percentage}%)`;
      }

      // Close modal when clicking outside
      document.getElementById('player-profile-modal').addEventListener('click', function(e) {
        if (e.target === this) {
          closePlayerProfile();
        }
      });

      // Close modal with Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closePlayerProfile();
        }
      });

      // Test functions for the buttons
      function testUpdateBestScore() {
        const userId = 'testUser_' + Date.now();
        const name = 'Test Player';
        const score = Math.floor(Math.random() * 5000) + 1000; // Random score between 1000-6000
        const department = 'College of Computer Studies';
        
        updateBestScore(userId, name, score, department).then(result => {
          showInfo(`Test Result: ${result.isNewBest ? 'New Best Score!' : 'Score not better than existing'}\nScore: ${score}`, {
            title: 'Test Result'
          });
          fetchLeaderboard('overall'); // Refresh the display
        }).catch(error => {
          showError('Error: ' + error.message, { title: 'Test Error' });
        });
      }

      function testGameIntegration() {
        // Simulate what the game would send
        const score = Math.floor(Math.random() * 10000) + 1500;
        const gameData = {
          userId: 'game_player_' + Date.now(),
          playerName: 'Advanced Player',
          score: score,
          department: 'College of Computer Studies',
          gameStats: {
            totalQuizzes: 12,
            correctAnswers: 89,
            comboScore: 25,
            playTime: 4800, // 80 minutes
            topicPoints: {
              'python': Math.floor(score * 0.28),
              'java': Math.floor(score * 0.24),
              'C_sharp_': Math.floor(score * 0.20), // Sanitized C# key
              'webdesign': Math.floor(score * 0.15),
              'C': Math.floor(score * 0.08),
              'C_plus_plus_': Math.floor(score * 0.05)
            },
            achievementCount: 9,
            courseProgress: {
              'intro_to_programming': true,
              'data_structures': true,
              'web_development': true,
              'algorithms': true,
              'advanced_topics': Math.random() > 0.5,
              'software_engineering': Math.random() > 0.3,
              'machine_learning': Math.random() > 0.8
            }
          }
        };
        
        console.log('Simulating game integration with data:', gameData);
        
        // Use addScore with enhanced data structure
        const userId = gameData.userId;
        const scoreData = {
          name: gameData.playerName,
          score: gameData.score,
          department: gameData.department,
          timestamp: Date.now(),
          submissionDate: new Date().toISOString(),
          gameData: {
            totalPoints: gameData.score,
            topicPoints: gameData.gameStats.topicPoints,
            achievementCount: gameData.gameStats.achievementCount,
            playTime: gameData.gameStats.playTime,
            courseProgress: gameData.gameStats.courseProgress
          }
        };
        
        db.ref('leaderboards/' + userId).set(scoreData)
          .then(() => {
            console.log('Game integration successful:', scoreData);
            showSuccess(`Game Integration Test: Advanced player created!\nScore: ${gameData.score}\nClick the player name to view detailed profile with charts.`, {
              title: 'üéÆ Game Integration Test'
            });
            fetchLeaderboard('overall');
          })
          .catch(error => {
            console.error('Game integration error:', error);
            showError('Integration Error: ' + error.message, { title: 'Integration Error' });
          });
      }

      // Function to test student score submission (for development)
      async function testStudentScore(studentId, score) {
        try {
          // Check if student exists first
          const studentsSnapshot = await db.ref('students').orderByChild('studentId').equalTo(studentId).once('value');
          
          if (!studentsSnapshot.exists()) {
            console.error('Student not found:', studentId);
            showWarning(`Student ${studentId} not found in the database. Please create the student first using developer tools.`, {
              title: 'Student Not Found'
            });
            return;
          }
          
          const studentData = Object.values(studentsSnapshot.val())[0];
          
          await addScore(studentId, studentData.name, score, 'Test Department');
          console.log(`Score ${score} submitted for student ${studentId}`);
          showSuccess(`Score submitted successfully for ${studentData.name}!`, {
            title: 'Score Submitted'
          });
          fetchLeaderboard('overall');
        } catch (error) {
          console.error('Error testing student score:', error);
          showError('Error: ' + error.message, { title: 'Submission Error' });
        }
      }

      // Helper Functions for Career Stats Display
      
      function generateCourseCompletionBadges(completionStatus) {
        const courses = {
          python: { name: 'Python', color: 'bg-blue-500', icon: 'üêç' },
          java: { name: 'Java', color: 'bg-orange-500', icon: '‚òï' },
          csharp: { name: 'C#', color: 'bg-purple-500', icon: 'üíé' },
          cpp: { name: 'C++', color: 'bg-green-500', icon: '‚ö°' },
          c: { name: 'C', color: 'bg-gray-500', icon: 'üîß' },
          webdesign: { name: 'Web Design', color: 'bg-pink-500', icon: 'üé®' }
        };
        
        return Object.entries(courses).map(([courseKey, course]) => {
          const isCompleted = completionStatus[courseKey] || false;
          return `
            <div class="bg-dark/50 p-3 rounded-lg text-center transition-all duration-300 ${isCompleted ? 'neon-border-success' : 'neon-border opacity-50'}">
              <div class="text-2xl mb-1">${course.icon}</div>
              <div class="text-xs font-gaming text-gray-300">${course.name}</div>
              <div class="text-xs mt-1 ${isCompleted ? 'text-green-400' : 'text-gray-500'}">
                ${isCompleted ? '‚úÖ Complete' : '‚è≥ Pending'}
              </div>
            </div>
          `;
        }).join('');
      }
      
      function generateCourseProgressBars(completionStatus, careerStats = null) {
        const courses = {
          python: { name: 'Python Programming', color: 'bg-blue-400' },
          java: { name: 'Java Development', color: 'bg-orange-400' },
          csharp: { name: 'C# Programming', color: 'bg-purple-400' },
          cpp: { name: 'C++ Programming', color: 'bg-green-400' },
          c: { name: 'C Programming', color: 'bg-gray-400' },
          webdesign: { name: 'Web Design', color: 'bg-pink-400' }
        };
        
        return Object.entries(courses).map(([courseKey, course]) => {
          const isCompleted = completionStatus[courseKey] || false;
          let percentage = 0;
          let statusText = 'Not Started';
          let sessionsInfo = '';
          
          // Calculate actual progress based on sessions
          if (careerStats && careerStats.coursesCompleted) {
            // Look for the course by key or by formatted name
            const courseData = careerStats.coursesCompleted[courseKey] || 
                              careerStats.coursesCompleted[course.name] ||
                              careerStats.coursesCompleted[course.name.toLowerCase()];
                              
            if (courseData && courseData.completedCount > 0) {
              const sessionsCompleted = courseData.completedCount;
              // Assume 3 intensities = 100% completion, but show progress even for partial completion
              percentage = isCompleted ? 100 : Math.min((sessionsCompleted / 3) * 100, 90); // Cap at 90% unless fully completed
              
              sessionsInfo = `${sessionsCompleted} session${sessionsCompleted > 1 ? 's' : ''} completed`;
              
              if (isCompleted) {
                statusText = '100% Complete';
              } else if (sessionsCompleted >= 2) {
                statusText = `${Math.round(percentage)}% (Intensity ${sessionsCompleted})`;
              } else {
                statusText = `${Math.round(percentage)}% (Intensity ${sessionsCompleted})`;
              }
            }
          } else if (isCompleted) {
            percentage = 100;
            statusText = '100% Complete';
          }
          
          const progressColor = isCompleted ? 'text-green-400' : percentage > 0 ? 'text-yellow-400' : 'text-gray-500';
          
          return `
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-300">${course.name}</span>
                <span class="${progressColor}">${statusText}</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-2">
                <div class="${course.color} h-2 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
              </div>
              ${sessionsInfo ? `<div class="text-xs text-gray-400">${sessionsInfo}</div>` : ''}
            </div>
          `;
        }).join('');
      }
      
      function generateRecentSessionsDisplay(recentSessions) {
        if (!recentSessions || Object.keys(recentSessions).length === 0) {
          return `
            <div class="text-center text-gray-400 py-8">
              <div class="text-4xl mb-2">üìö</div>
              <div>No recent sessions</div>
              <div class="text-sm">Complete some quizzes to see activity here!</div>
            </div>
          `;
        }
        
        // Get the last 5 sessions
        const sessions = Object.entries(recentSessions)
          .sort(([,a], [,b]) => new Date(b.timestamp) - new Date(a.timestamp))
          .slice(0, 5);
        
        return sessions.map(([sessionId, session]) => {
          const date = new Date(session.timestamp).toLocaleDateString();
          const accuracy = session.accuracyPercentage || 0;
          const scoreColor = accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400';
          
          // Use courseTopic instead of course, and format it nicely
          const courseName = session.courseTopic || 'Unknown';
          const formattedCourseName = formatCourseName(courseName);
          
          return `
            <div class="flex items-center gap-3 p-3 bg-dark/50 rounded neon-border">
              <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-dark font-bold">
                ${formattedCourseName.charAt(0).toUpperCase()}
              </div>
              <div class="flex-1">
                <div class="font-medium text-primary">${formattedCourseName}</div>
                <div class="text-xs text-gray-400">${date} ‚Ä¢ ${(session.correctAnswers || 0) + (session.wrongAnswers || 0)} questions</div>
              </div>
              <div class="text-right">
                <div class="font-bold ${scoreColor}">${accuracy.toFixed(1)}%</div>
                <div class="text-xs text-gray-400">${session.totalScore || 0} pts</div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      function initializeCareerStatsCharts(career, completionStatus, recentSessions) {
        console.log('üé® Initializing lightweight custom charts...');
        console.log('üìä Career data:', career);
        
        // Create Career Performance Line Chart
        createCareerLineChart(career);
        
        // Create Performance Radar Chart
        createPerformanceRadarChart(career, completionStatus);
        
        console.log('‚úÖ Custom charts initialized');
      }

      // Lightweight Line Chart for Career Performance
      function createCareerLineChart(career) {
        const canvas = document.getElementById('careerChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const container = canvas.parentElement;
        
        // Set canvas size to match container with proper centering
        const containerRect = container.getBoundingClientRect();
        const size = Math.min(containerRect.width, containerRect.height) * 0.9; // 90% of container
        
        canvas.width = size * window.devicePixelRatio;
        canvas.height = size * window.devicePixelRatio;
        canvas.style.width = size + 'px';
        canvas.style.height = size + 'px';
        
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        
        const width = size;
        const height = size;
        const padding = 30;
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        // Chart data
        const totalPoints = career.totalPoints || 0;
        const data = [
          0,
          Math.floor(totalPoints * 0.2),
          Math.floor(totalPoints * 0.5),
          Math.floor(totalPoints * 0.8),
          totalPoints
        ];
        const labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Current'];
        
        const maxValue = Math.max(...data) || 100;
        
        // Draw background
        ctx.fillStyle = 'rgba(26, 26, 46, 0.8)';
        ctx.fillRect(0, 0, width, height);
        
        // Draw grid lines
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 1;
        
        for (let i = 0; i <= 4; i++) {
          const y = padding + (i * (height - 2 * padding)) / 4;
          ctx.beginPath();
          ctx.moveTo(padding, y);
          ctx.lineTo(width - padding, y);
          ctx.stroke();
        }
        
        // Draw data line
        ctx.strokeStyle = '#00ff88';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        for (let i = 0; i < data.length; i++) {
          const x = padding + (i * (width - 2 * padding)) / (data.length - 1);
          const y = height - padding - (data[i] / maxValue) * (height - 2 * padding);
          
          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.stroke();
        
        // Draw data points
        ctx.fillStyle = '#00ff88';
        for (let i = 0; i < data.length; i++) {
          const x = padding + (i * (width - 2 * padding)) / (data.length - 1);
          const y = height - padding - (data[i] / maxValue) * (height - 2 * padding);
          
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, 2 * Math.PI);
          ctx.fill();
        }
        
        // Draw labels
        ctx.fillStyle = '#ffffff';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        
        for (let i = 0; i < labels.length; i++) {
          const x = padding + (i * (width - 2 * padding)) / (labels.length - 1);
          ctx.fillText(labels[i], x, height - 10);
        }
        
        // Draw values
        ctx.textAlign = 'left';
        for (let i = 0; i <= 4; i++) {
          const value = Math.round((maxValue * (4 - i)) / 4);
          const y = padding + (i * (height - 2 * padding)) / 4;
          ctx.fillText(value.toString(), 5, y + 4);
        }
        
        // Hide fallback
        const fallback = document.getElementById('careerChartFallback');
        if (fallback) fallback.style.display = 'none';
        
        console.log('‚úÖ Career line chart created');
      }

      // Lightweight Radar Chart for Performance Metrics
      function createPerformanceRadarChart(career, completionStatus) {
        const canvas = document.getElementById('performanceRadar');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const container = canvas.parentElement;
        
        // Set canvas size to match container with proper centering
        const containerRect = container.getBoundingClientRect();
        const size = Math.min(containerRect.width, containerRect.height) * 0.9; // 90% of container
        
        canvas.width = size * window.devicePixelRatio;
        canvas.height = size * window.devicePixelRatio;
        canvas.style.width = size + 'px';
        canvas.style.height = size + 'px';
        
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        
        const width = size;
        const height = size;
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = Math.min(width, height) / 2 - 30;
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        // Chart data
        const completedCourses = Object.values(completionStatus).filter(Boolean).length;
        const totalCourses = Object.keys(completionStatus).length;
        const completionPercentage = totalCourses > 0 ? (completedCourses / totalCourses) * 100 : 0;
        
        const data = [
          career.averageAccuracy || 0,
          Math.min(100, (career.totalSessions || 0) * 10),
          Math.min(100, (career.highestStreak || 0) * 5),
          completedCourses * 16.67,
          completionPercentage
        ];
        
        const labels = ['Accuracy', 'Speed', 'Consistency', 'Difficulty', 'Completion'];
        const angles = labels.map((_, i) => (i * 2 * Math.PI) / labels.length - Math.PI / 2);
        
        // Draw background
        ctx.fillStyle = 'rgba(26, 26, 46, 0.8)';
        ctx.fillRect(0, 0, width, height);
        
        // Draw grid circles
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 1;
        
        for (let i = 1; i <= 5; i++) {
          ctx.beginPath();
          ctx.arc(centerX, centerY, (radius * i) / 5, 0, 2 * Math.PI);
          ctx.stroke();
        }
        
        // Draw grid lines
        for (let i = 0; i < angles.length; i++) {
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.lineTo(
            centerX + Math.cos(angles[i]) * radius,
            centerY + Math.sin(angles[i]) * radius
          );
          ctx.stroke();
        }
        
        // Draw data area
        ctx.fillStyle = 'rgba(0, 255, 136, 0.2)';
        ctx.strokeStyle = '#00ff88';
        ctx.lineWidth = 2;
        
        ctx.beginPath();
        for (let i = 0; i < data.length; i++) {
          const value = data[i] / 100; // Normalize to 0-1
          const x = centerX + Math.cos(angles[i]) * radius * value;
          const y = centerY + Math.sin(angles[i]) * radius * value;
          
          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
        
        // Draw data points
        ctx.fillStyle = '#00ff88';
        for (let i = 0; i < data.length; i++) {
          const value = data[i] / 100;
          const x = centerX + Math.cos(angles[i]) * radius * value;
          const y = centerY + Math.sin(angles[i]) * radius * value;
          
          ctx.beginPath();
          ctx.arc(x, y, 3, 0, 2 * Math.PI);
          ctx.fill();
        }
        
        // Draw labels
        ctx.fillStyle = '#ffffff';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        
        for (let i = 0; i < labels.length; i++) {
          const labelRadius = radius + 20;
          const x = centerX + Math.cos(angles[i]) * labelRadius;
          const y = centerY + Math.sin(angles[i]) * labelRadius;
          
          ctx.fillText(labels[i], x, y + 4);
        }
        
        // Hide fallback
        const fallback = document.getElementById('radarChartFallback');
        if (fallback) fallback.style.display = 'none';
        
        console.log('‚úÖ Performance radar chart created');
      }

      // Enhanced API for external access
      window.leaderboardAPI = {
        loadCareerStatsData,
        fetchLeaderboard,
        showPlayerProfile: showPlayerProfile
      };

      // Make test function available globally
      window.testStudentScore = testStudentScore;

      // Mobile menu functionality
      document.addEventListener('DOMContentLoaded', () => {
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        
        if (mobileMenuBtn && mobileMenu) {
          mobileMenuBtn.addEventListener('click', () => {
            const isHidden = mobileMenu.style.display === 'none' || !mobileMenu.style.display;
            mobileMenu.style.display = isHidden ? 'block' : 'none';
            
            // Update aria-expanded
            mobileMenuBtn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
            
            // Update icon
            const svg = mobileMenuBtn.querySelector('svg');
            if (svg) {
              if (isHidden) {
                svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />';
              } else {
                svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />';
              }
            }
          });
          
          // Close mobile menu when clicking on a link
          const mobileLinks = mobileMenu.querySelectorAll('a, button');
          mobileLinks.forEach(link => {
            link.addEventListener('click', () => {
              mobileMenu.style.display = 'none';
              mobileMenuBtn.setAttribute('aria-expanded', 'false');
              const svg = mobileMenuBtn.querySelector('svg');
              if (svg) {
                svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />';
              }
            });
          });
        }
      });
    </script>
  </body>
</html>
